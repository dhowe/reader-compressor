<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>readers codec viewer</title>

  <!-- Data Source Script Tags -->
  <script src="data/compression/PerigramReader.1770546914199-layout.js"></script>
  <script src="data/compression/theImage-lines.js"></script>
  <script src="data/completions/Feb8.12pm.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap');

    body {
      font-family: 'IBM Plex Mono', monospace;
      background-color: #ffffff;
      margin: 0;
      padding: 0;
      color: #000000;
      overflow: hidden;
    }

    /* Unified scrollbar for the entire application */
    main {
      height: 100vh;
      overflow-y: auto;
      padding: 20px 10px;
      box-sizing: border-box;
    }

    .row-wrapper {
      display: flex;
      width: 100%;
      min-width: fit-content;
      /* Ensure highlights span full height of the row */
      align-items: stretch;
    }

    .cell {
      font-size: 13px;
      white-space: pre;
      line-height: 2;
      padding: 0 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    /* Line Number Column */
    .cell-no {
      width: 50px;
      text-align: right;
      color: #ccc;
      user-select: none;
      border-right: 1px solid #f0f0f0;
    }

    /* Column widths */
    .cell-layout {
      flex: 1;
    }

    .cell-fills {
      flex: 1;
    }

    .cell-lines {
      flex: 1;
    }

    /* Fills Cell Alignment for (num) */
    .cell-fills {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }

    .text-content {
      white-space: pre;
    }

    /* Highlights (Applied to cells) */
    .bg-red {
      background-color: rgba(255, 0, 0, 0.08) !important;
      /* Faint Red */
    }

    .bg-green {
      background-color: rgba(144, 238, 144, 0.4) !important;
      /* Light Green */
    }

    /* Text Decoration */
    u {
      text-decoration: underline;
      text-underline-offset: 4px;
    }

    s {
      text-decoration: line-through;
      color: #000;
    }

    /* Vertical alignment for difference indicators */
    .diff-tag {
      font-weight: bold;
      color: #d00;
      padding-left: 15px;
      text-align: right;
    }
  </style>
</head>

<body>

  <main id="unified-container"></main>

  <script>
    window.addEventListener('load', () => {
      const container = document.getElementById('unified-container');

      if (typeof layout === 'undefined' || typeof lines === 'undefined' || typeof fills === 'undefined') {
        console.error("Required data arrays (layout, lines, fills) not found in scope.");
        return;
      }

      layout.forEach((_, i) => {
        const layoutStr = layout[i] || "";
        const fillStr = fills[i] || "";
        const lineStr = lines[i] || "";

        const rowWrapper = document.createElement('div');
        rowWrapper.className = 'row-wrapper';

        // 0. Line Number (Far Left)
        const cellNo = document.createElement('div');
        cellNo.className = 'cell cell-no';
        cellNo.textContent = i;

        // 1. Layout Cell
        const cellLayout = document.createElement('div');
        cellLayout.className = 'cell cell-layout';
        cellLayout.innerHTML = processLayoutStrikethrough(layoutStr, fillStr);

        // 2. Fills Cell (Center)
        const cellFills = document.createElement('div');
        cellFills.className = 'cell cell-fills';

        let fillTextHTML = applyUnderlines(fillStr, layoutStr);
        let diffHTML = "";

        // Condition: Fills matches Lines exactly
        if (fillStr === lineStr) {
          cellFills.classList.add('bg-green');
        }

        // Condition: Length mismatch between Fills and Layout
        if (fillStr.length !== layoutStr.length) {
          cellFills.classList.add('bg-red');
          const diff = fillStr.length - layoutStr.length;
          const sign = diff > 0 ? "+" : "";
          diffHTML = `<span class="diff-tag">(${sign}${diff})</span>`;
        }

        cellFills.innerHTML = `<span class="text-content">${fillTextHTML}</span>${diffHTML}`;

        // 3. Lines Cell (Right)
        const cellLines = document.createElement('div');
        cellLines.className = 'cell cell-lines';
        cellLines.innerHTML = applyUnderlines(lineStr, layoutStr);

        // Assemble row: [No] [Layout] [Fills] [Lines]
        rowWrapper.appendChild(cellNo);
        rowWrapper.appendChild(cellLayout);
        rowWrapper.appendChild(cellFills);
        rowWrapper.appendChild(cellLines);
        container.appendChild(rowWrapper);
      });
    });

    /**
     * Strikethrough Logic: 
     * Finds "words" in Layout (non-dash, non-space sequences).
     * If that word is NOT found anywhere in the Fills string, strike it through.
     */
    function processLayoutStrikethrough(layoutStr, fillsStr) {
      const wordRegex = /([^ \-]+)/g;
      let lastIdx = 0;
      let html = "";
      let match;

      while ((match = wordRegex.exec(layoutStr)) !== null) {
        // Add any space or dashes before the word
        html += layoutStr.slice(lastIdx, match.index);

        const word = match[0];
        // Check if word exists at all in the center column
        if (!fillsStr.includes(word)) {
          html += `<s>${word}</s>`;
        } else {
          html += word;
        }
        lastIdx = wordRegex.lastIndex;
      }
      // Add remaining trailing characters
      html += layoutStr.slice(lastIdx);
      return html;
    }

    /**
     * Underlines characters in text if Layout has a dash '-' at that index
     */
    function applyUnderlines(text, mask) {
      let html = "";
      for (let j = 0; j < text.length; j++) {
        const char = text[j];
        const maskChar = mask[j] || " ";
        if (maskChar === '-') {
          html += `<u>${char}</u>`;
        } else {
          html += char;
        }
      }
      return html;
    }
  </script>

</body>

</html>